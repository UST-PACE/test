image:
  repository: "otel/opentelemetry-collector-contrib"

mode: deployment

ports:
  otlp-http:
    enabled: true
  jaeger-compact:
    enabled: false
  jaeger-thrift:
    enabled: false
  jaeger-grpc:
    enabled: false
  zipkin:
    enabled: false

config:
  extensions:
    basicauth/grafana_cloud:
      client_auth:
        username: ${env:GF_CLOUD_OTLP_USERNAME}
        password: ${env:GF_CLOUD_OTLP_PASSWORD}
    basicauth/server:
      htpasswd:
         inline: |
          ${env:BASIC_AUTH_USERNAME}:${env:BASIC_AUTH_PASSWORD}

  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
          auth:
            authenticator: basicauth/server
        http:
          endpoint: 0.0.0.0:4318
    prometheus: {}  # Required for metrics pipeline; ensure it's included

  processors:
    memory_limiter:
      check_interval: 1s
      limit_percentage: 65
      spike_limit_percentage: 20

    cumulativetodelta:

    filter/histograms:
      error_mode: ignore
      metrics:
        metric:
        - 'type == METRIC_DATA_TYPE_HISTOGRAM'

    k8sattributes:
      auth_type: serviceAccount
      extract:
        metadata:
          - k8s.cluster.name
          - k8s.namespace.name
          - k8s.pod.name
          - k8s.node.name
      pod_association:
        - from: resource_attribute
          name: k8s.pod.ip
        - from: connection

  connectors:
    spanmetrics: {}
    servicegraph: {}

  exporters:
    otlphttp/grafana_cloud:
      endpoint: https://otlp-gateway-prod-ap-south-1.grafana.net/otlp
      auth:
        authenticator: basicauth/grafana_cloud

  service:
    extensions: [basicauth/server, health_check, basicauth/grafana_cloud]
    pipelines:
      logs:
        receivers: [otlp]
        exporters:
          - otlphttp/grafana_cloud
      logs/k8s_events:
        receivers:
          - otlp
        exporters:
          - otlphttp/grafana_cloud
      metrics:
        receivers:
          - otlp
          - prometheus
        processors:  # ‚Üê ADDED processors section to metrics pipeline
          - memory_limiter
          - cumulativetodelta
          - filter/histograms
          - k8sattributes
        exporters:
          - otlphttp/grafana_cloud

extraEnvs:
  - name: BASIC_AUTH_USERNAME
    valueFrom:
      secretKeyRef:
        name: otel-collector-creds
        key: username
  - name: BASIC_AUTH_PASSWORD
    valueFrom:
      secretKeyRef:
        name: otel-collector-creds
        key: password
  - name: GF_CLOUD_OTLP_USERNAME
    valueFrom:
      secretKeyRef:
        name: otel-collector-creds
        key: GF_CLOUD_OTLP_USERNAME
  - name: GF_CLOUD_OTLP_PASSWORD
    valueFrom:
      secretKeyRef:
        name: otel-collector-creds
        key: GF_CLOUD_OTLP_PASSWORD

service:
  enabled: true

clusterRole:
  create: true
  rules:
    - apiGroups:
        - ''
      resources:
        - nodes
        - nodes/proxy
        - services
        - endpoints
        - pods
        - events
        - namespaces
        - namespaces/status
        - pods/status
        - replicationcontrollers
        - replicationcontrollers/status
        - resourcequotas
      verbs:
        - get
        - list
        - watch
    - nonResourceURLs:
        - /metrics
      verbs:
        - get
    - apiGroups:
        - apps
      resources:
        - daemonsets
        - deployments
        - replicasets
        - statefulsets
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - extensions
      resources:
        - daemonsets
        - deployments
        - replicasets
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - batch
      resources:
        - jobs
        - cronjobs
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - autoscaling
      resources:
        - horizontalpodautoscalers
      verbs:
        - get
        - list
        - watch

resources:
  limits:
    cpu: 300m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi
