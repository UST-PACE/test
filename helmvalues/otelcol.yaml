mode: deployment
replicaCount: 1

image:
  repository: otel/opentelemetry-collector
  tag: 0.131.0
  pullPolicy: IfNotPresent

service:
  type: ClusterIP

config:
  receivers:
    otlp:
      protocols:
        grpc:
        http:
    prometheus:
      config:
        scrape_configs:
          - job_name: 'kubernetes-apiservers'
            kubernetes_sd_configs:
              - role: endpoints
            scheme: https
            tls_config:
              insecure_skip_verify: true
            relabel_configs:
              - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                action: keep
                regex: default;kubernetes;https

  processors:
    memory_limiter:
      check_interval: 1s
      limit_mib: 512
      spike_limit_mib: 128
    batch:

  exporters:
    debug: {}
    prometheus:
      endpoint: "0.0.0.0:8888"

  service:
    extensions: [health_check]
    pipelines:
      metrics:
        receivers: [otlp, prometheus]
        processors: [memory_limiter, batch]
        exporters: [debug, prometheus]
      traces:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [debug]
      logs:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [debug]

extraEnvs:
  - name: CLUSTER_NAME
    value: "k3s-test"
